---
# Since usage of the --config flag for reconfiguring the cluster during upgrade is not recommended
# (warning added in v1.17), we patch kubeadm-config ConfigMap directly.

# kube-apiserver uses --encryption-provider-config parameter to control how data is encrypted in etcd.
# If this parameter is absent the encryption is not enabled.
- name: upgrade-master | Check if encryption of secret data is enabled
  lineinfile:
    dest: /etc/kubernetes/manifests/kube-apiserver.yaml
    regexp: '--encryption-provider-config'
    state: absent
  register: lineinfile_encryption_flag
  check_mode: true
  changed_when: false

- name: upgrade-master | Patch kubeadm-config ConfigMap if needed
  when:
    - lineinfile_encryption_flag.found  # encryption enabled
  block:
    - name: upgrade-master | Get kubeadm-config ConfigMap
      shell: |
        kubectl get configmap kubeadm-config \
          --namespace kube-system \
          --output yaml
      environment:
        KUBECONFIG: &KUBECONFIG /etc/kubernetes/admin.conf
      register: shell_kubeadm_configmap
      changed_when: false

    # The following procedure ensures that etcd encryption is always enabled during subsequent kubeadm executions
    - name: upgrade-master | Patch kubeadm-config ConfigMap (patch-kubeadm-config.yml)
      when:
        - _kubeadm_api_server_extra_args['encryption-provider-config'] is undefined
      shell: |
        kubectl patch configmap kubeadm-config \
          --namespace kube-system \
          --patch "$KUBEADM_CONFIGMAP_DOCUMENT"
      environment:
        KUBECONFIG: *KUBECONFIG
        # Render an altered kubeadm-config configmap document
        KUBEADM_CONFIGMAP_DOCUMENT: >-
          {{ _document | combine(_update2, recursive=true) | to_nice_yaml(indent=2) }}

      vars:
        # Parse yaml payload
        _document: >-
          {{ shell_kubeadm_configmap.stdout | from_yaml }}

        # Extract cluster config
        _cluster_config: >-
          {{ _document.data.ClusterConfiguration | from_yaml }}

        _kubeadm_api_server_extra_args: >-
          {{ _cluster_config.apiServer.extraArgs }}

        # Prepare the cluster config patch
        _update1:
          apiServer:
            extraArgs:
              encryption-provider-config: /etc/kubernetes/pki/etcd/etc-encryption.conf

        _cluster_config_updated: >-
          {{ _cluster_config | combine(_update1, recursive=true) }}

        # Prepare the final update for the whole document
        _update2:
          data:
            ClusterConfiguration: >-
              {{ _cluster_config_updated | to_nice_yaml(indent=2) }}
