---
# This role is responsible for installing and configuring Hashicorp Vault
# TODO: Add swap disable
# TODO: Check licenses for Hashicorp Vault policies used by Epiphany
# TODO: Limit to set only on 1 master until vault will be clustered

- name: Install and configure Hashicorp Vault if enabled
  when:
    - specification.vault_enabled
  block:
    - name: Create Vault system group
      group:
        name: "{{ specification.vault_system_group }}"
        system: yes

    - name: Create Vault system user
      user:
        name: "{{ specification.vault_system_user }}"
        group: "{{ specification.vault_system_group }}"
        system: yes
        shell: "/usr/sbin/nologin"

    - name: Create Vault directories
      file:
        path: "{{ specification.vault_install_dir }}/{{ item }}"
        state: directory
        owner: "{{ specification.vault_system_user }}"
        group: "{{ specification.vault_system_group }}"
        mode: u=rwx,g=rx,o=
      loop:
        - "bin"
        - "config"
        - "data"
        - "kubernetes"
        - "logs"
        - "config/policies"
        - "tls"

    - name: Set Vault file name to install
      set_fact:
        vault_file_name: "{{ specification.file_name }}"

    - name: Download Vault binaries
      include_role:
        name: download
        tasks_from: download_file
      vars:
        file_name: "{{ vault_file_name }}"

    - name: Check for Vault package
      stat:
        path: "{{ specification.vault_install_dir }}/bin/vault"
      register: vault_package

    - name: Uncompress the Vault zip
      when: not vault_package.stat.exists
      unarchive:
        remote_src: yes
        owner: "{{ specification.vault_system_user }}"
        group: "{{ specification.vault_system_group }}"
        src: "{{ download_directory }}/{{ vault_file_name }}"
        creates: "{{ specification.vault_install_dir }}/bin/vault"
        dest: "{{ specification.vault_install_dir }}/bin/"
        mode: u=rwx,g=rx,o=

    - name: Create a symbolic link to Vault
      file:
        src: "{{ specification.vault_install_dir }}/bin/vault"
        dest: /usr/local/bin/vault
        owner: "{{ specification.vault_system_user }}"
        group: "{{ specification.vault_system_group }}"
        state: link

    - name: Create Vault configuration file
      template:
        dest: "{{ specification.vault_install_dir }}/config/config.hcl"
        owner: "{{ specification.vault_system_user }}"
        group: "{{ specification.vault_system_group }}"
        mode: u=rw,g=r,o=
        src: vault/config.hcl.j2

    - name: Set capabilities required to lock memory
      capabilities:
        path: "{{ specification.vault_install_dir }}/bin/vault"
        capability: cap_ipc_lock=+ep
        state: present

    - name: Set fs.suid_dumpable to 0
      sysctl:
        name: fs.suid_dumpable
        value: '0'
        sysctl_set: yes
        state: present
        reload: yes

    - name: Set security limits for Vault
      pam_limits:
        domain: '*'
        limit_type: hard
        limit_item: core
        value: '0'

    - name: Copy Vault unseal script
      copy:
        src: vault/unseal-vault.sh
        dest: "{{ specification.vault_install_dir }}/bin/"
        owner: "{{ specification.vault_system_user }}"
        group: "{{ specification.vault_system_group }}"
        mode: u=rwx,g=rx,o=

    - name: Create systemd config
      template:
        dest: /etc/systemd/system/vault.service
        owner: root
        group: root
        mode: u=rw,g=r,o=
        src: vault/vault.service.j2
      register: service_conf

    - name: Find certificate file in role directory
      local_action: find paths="{{ role_path }}/files/tls-certs" patterns="*.pem" 
      become: no
      register: certificates_names

    - name: Check if any certificate exist in role directory
      set_fact:
        certificates_exist: "{{ certificates_names is defined and (certificates_names.files | length > 0) }}"

    - name: Display if certificate file in role directory exists
      debug:
        msg: "Certificate exists"
      when:
        - certificates_exist

    - name: Copy certificate remotely if certificate file in role directory exists
      copy:
        src: "{{ item.path }}"
        dest: "{{ specification.vault_install_dir }}/tls/"
      loop: "{{ certificates_names.files }}"
      when:
        - certificates_exist

    - name: Generate TLS certificate
      include_tasks: certificate_generate.yml
      when:
        - not certificates_exist

    - name: Restart Vault service and reload config
      systemd:
        name: vault
        state: restarted
        daemon_reload: yes
      when:
        - service_conf.changed

    - name: Start Vault service
      systemd:
        name: vault
        state: started
        enabled: yes

    - name: Copy Vault configuration script
      copy:
        src: vault/configure-vault.sh
        dest: "{{ specification.vault_install_dir }}/bin/"
        owner: "{{ specification.vault_system_user }}"
        group: "{{ specification.vault_system_group }}"
        mode: u=rwx,g=rx,o=

    - name: Copy Vault policies configuration
      copy:
        src: "vault/{{ item }}"
        dest: "{{ specification.vault_install_dir }}/config/policies/"
        owner: "{{ specification.vault_system_user }}"
        group: "{{ specification.vault_system_group }}"
        mode: u=rw,g=r,o=
      loop:
        - policy-admin.hcl
        - policy-provisioner.hcl

    - name: Generate application policy
      template:
        dest: "{{ specification.vault_install_dir }}/config/policies/policy-application.hcl"
        owner: "{{ specification.vault_system_user }}"
        group: "{{ specification.vault_system_group }}"
        mode: u=rw,g=r,o=
        src: vault/policy-application.hcl.j2

    - name: Generate config script confiugration
      template:
        dest: "{{ specification.vault_install_dir }}/script.config"
        owner: "{{ specification.vault_system_user }}"
        group: "{{ specification.vault_system_group }}"
        mode: u=rw,g=r,o=
        src: vault/script.config.j2

    - name: Generate users to be created by the script
      template:
        dest: "{{ specification.vault_install_dir }}/users.csv"
        owner: "{{ specification.vault_system_user }}"
        group: "{{ specification.vault_system_group }}"
        mode: u=rw,g=r,o=
        src: vault/users.csv.j2

    - name: Create application namespace yaml
      template:
        dest: "{{ specification.vault_install_dir }}/kubernetes/app-namespace.yml"
        owner: "{{ specification.vault_system_user }}"
        group: "{{ specification.vault_system_group }}"
        mode: u=rw,g=r,o=
        src: kubernetes/app-namespace.yml.j2
      when: not specification.kubernetes_namespace == "default"

    - name: Create Vault endpoint configuration yaml
      template:
        dest: "{{ specification.vault_install_dir }}/kubernetes/vault-endpoint-configuration.yml"
        owner: "{{ specification.vault_system_user }}"
        group: "{{ specification.vault_system_group }}"
        mode: u=rw,g=r,o=
        src: kubernetes/vault-endpoint-configuration.yml.j2

    - name: Create Vault service account yaml
      template:
        dest: "{{ specification.vault_install_dir }}/kubernetes/vault-service-account.yml"
        owner: "{{ specification.vault_system_user }}"
        group: "{{ specification.vault_system_group }}"
        mode: u=rw,g=r,o=
        src: kubernetes/vault-service-account.yml.j2

    - name: Create application service account yaml
      template:
        dest: "{{ specification.vault_install_dir }}/kubernetes/app-service-account.yml"
        owner: "{{ specification.vault_system_user }}"
        group: "{{ specification.vault_system_group }}"
        mode: u=rw,g=r,o=
        src: kubernetes/app-service-account.yml.j2

    - name: Check if Vault_protocol is set to http
      set_fact:
        vault_protocol: "http"
      when: specification.tls_disable

    - name: Check if Vault_protocol is set to https
      set_fact:
        vault_protocol: "https"
      when: not specification.tls_disable

    - name: Run configuration script
      when:
        - specification.vault_script_autoconfiguration
      shell: >-
        {{ specification.vault_install_dir }}/bin/configure-vault.sh
        -c {{ specification.vault_install_dir }}/script.config
        -a {{ ansible_default_ipv4.address }}
        -p {{ vault_protocol }}

    - name: Display information about running configuration script
      when:
        - not specification.vault_script_autoconfiguration
      debug:
        msg: "Init file doesn't exist or you have chosen manual unseal, so to finish configuration please run script manually with command:
              {{ specification.vault_install_dir }}/bin/configure-vault.sh -c {{ specification.vault_install_dir }}/script.config -a {{ ansible_default_ipv4.address }}.
              Also please put 'init.txt' file, containing output from 'vault operator init' command, in ''{{ specification.vault_install_dir }}' directory."
